<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventário da Oficina</title>
<style>
  body { font-family: Arial, sans-serif; background:#0f1720; color:#e6eef6; margin:0; padding:20px; }
  h1 { text-align:center; }
  .container { max-width:1000px; margin:0 auto; }
  .card { background:#14212d; padding:20px; border-radius:12px; margin-bottom:20px; }
  label { display:block; margin-top:10px; font-size:14px; }
  input, select, textarea { width:100%; padding:8px; border-radius:6px; border:1px solid #2a3a4d; background:#0d1a24; color:#e6eef6; box-sizing: border-box; }
  .row { display:flex; gap:12px; }
  .row > * { flex:1; }
  .inline { display:flex; gap:8px; align-items:center; }
  button { margin-top:15px; padding:10px 16px; border:none; border-radius:8px; cursor:pointer; background:#2b9cff; color:white; }
  button:hover { background:#1a8be0; }
  button.secondary { background: #2a3a4d; }
  .muted { color:#98a3b3; font-size:13px; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { padding:10px; border-bottom:1px solid #2a3a4d; text-align:left; }
  th { background:#1c2b38; }
  /* Estilo para o checkbox */
  input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
  .top-actions { display:flex; gap:8px; align-items:center; margin-bottom:6px; flex-wrap: wrap; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
  <h1>Inventário da Oficina</h1>
  
  <div class="card">
    <h2>Adicionar Máquina</h2>
    <div class="row">
      <div>
        <label>OM</label>
        <input id="om" placeholder="Número da OM" />
      </div>
      <div>
        <label>Patrimônio</label>
        <input id="patrimonio" placeholder="Número do patrimônio" />
      </div>
    </div>
    <label>Nome da Máquina</label>
    <div class="inline">
      <input id="nome" list="equipamentosList" placeholder="Digite ou escolha..." onchange="autofill()" />
      <button id="autoFillBtn" type="button" class="secondary" onclick="autofill()">Auto preencher</button>
    </div>
    <datalist id="equipamentosList"></datalist>
    <div class="row">
      <div>
        <label>Preço do Ativo (R$)</label>
        <input id="preco" type="number" step="any" placeholder="Valor de compra" />
      </div>
      <div>
        <label>Horas trabalhadas (Por OM)</label>
        <input id="horas" type="number" step="any" />
      </div>
    </div>
    <label>Valor da mão de obra (R$ / OM)</label>
    <input id="valor" type="number" step="any" />
    <label>Status</label>
    <select id="status">
      <option value="Disponível">Disponível</option>
      <option value="Aguardando peça">Aguardando peça</option>
      <option value="Em serviço">Em serviço</option>
    </select>
    <label>Observação</label>
    <textarea id="obs" rows="3"></textarea>
    <button onclick="addItem()">Salvar Máquina</button>
  </div>

  <div class="card">
    <div class="top-actions">
      <div style="flex:1"><h2 style="margin:0">Inventário</h2></div>
      <div style="display:flex;gap:8px">
        <button onclick="exportPDF()">Exportar PDF</button>
        <button onclick="exportExcel()">Exportar Excel</button>
        <button onclick="deleteSelected()" style="background:#d93025;">Excluir</button>
      </div>
    </div>
    <p class="muted">Selecione os itens na tabela para exportar ou excluir.</p>
    <table>
      <thead>
        <tr>
          <th style="width: 40px; text-align: center;">
            <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">
          </th>
          <th>OM</th>
          <th>Patrimônio</th>
          <th>Nome</th>
          <th>Preço Ativo</th>
          <th>Horas/OM</th>
          <th>Vlr. M.Obra</th>
          <th>Status</th>
          <th>Obs</th>
        </tr>
      </thead>
      <tbody id="lista"></tbody>
    </table>
  </div>
</div>

<script>
// --- BANCO DE DADOS DA TABELA DE IMAGEM ---
// Mapeamento: Chave = Nome, Valor = { valor_mo: $/OM Normal, horas: Tempo em Hrs }
const tabelaPrecos = {
  "ACABADORA DE SUPERF": { valor: 2.00, horas: 5 },
  "BALANCIM CADEIRINHA": { valor: 2.00, horas: 2.25 },
  "BANCADA DE SERRA": { valor: 8.00, horas: 4.5 },
  "BETONEIRA 150 LT": { valor: 6.00, horas: 4.5 },
  "BETONEIRA 400LT": { valor: 6.00, horas: 4.5 },
  "BETONEIRA 600LT": { valor: 16.90, horas: 16 },
  "BOMBA MANGOTE": { valor: 4.00, horas: 3 },
  "BOMBA SUBMERSA": { valor: 4.00, horas: 4 },
  "COMPACTADOR": { valor: 3.00, horas: 4 },
  "CORTADORA": { valor: 3.00, horas: 4 },
  "GERADOR": { valor: 3.00, horas: 3.2 },
  "GUINCHO DE ELEVAÇÃO": { valor: 10.00, horas: 6 },
  "MARTELO 2 KG - 220V": { valor: 1.50, horas: 2 },
  "MARTELO 5,7 KG - 220V": { valor: 1.50, horas: 2 },
  "MARTELO 6 KG - 220V": { valor: 1.70, horas: 2 },
  "MARTELO 11 KG - ROT": { valor: 2.00, horas: 2.2 },
  "MARTELO 11 KG - 220V": { valor: 1.70, horas: 2.2 },
  "MARTELO 16/19 KG": { valor: 2.00, horas: 2.3 },
  "MARTELO 19 KG - 220V": { valor: 2.00, horas: 2.5 },
  "MARTELO 30 KG - 220V": { valor: 2.00, horas: 2.5 },
  "MINI GRUA": { valor: 10.00, horas: 6 },
  "MOTOR - ACIONADOR": { valor: 3.00, horas: 3 },
  "MOTOR - ELET_TRIFA": { valor: 3.00, horas: 3 },
  "PLACA VIBRATORIA": { valor: 3.50, horas: 4.5 },
  "REGUA VIBRATORIA": { valor: 5.00, horas: 4.5 },
  "TORRE DE ILUMINACAO": { valor: 25.00, horas: 6 },
  "UNIDADES HIDRAULICA": { valor: 8.00, horas: 16 },
  "VIBRADOR DE IMERSAO": { valor: 2.80, horas: 4 },
  "ROLO COMPACTADOR": { valor: 20.00, horas: 24 },
  "MINI CARREGADEIRA": { valor: 34.00, horas: 16 },
  "MINI ESCAVADEIRA": { valor: 34.00, horas: 16 },
  "VELOX": { valor: 8.00, horas: 6 },
  "PERFURATRIZ": { valor: 25.00, horas: 6 },
  "MAQUINA PESADA": { valor: 34.00, horas: 16 }
};

// Dados Iniciais (Simulando LocalStorage se vazio)
let inventoryData = JSON.parse(localStorage.getItem('oficina_inventory')) || [];

// Preenche o DataList com as chaves do objeto tabelaPrecos
function populateOptions(){
    const datalist = document.getElementById('equipamentosList');
    datalist.innerHTML = '';
    // Ordena alfabeticamente para facilitar a busca
    Object.keys(tabelaPrecos).sort().forEach(item => {
        let option = document.createElement('option');
        option.value = item;
        datalist.appendChild(option);
    });
}

// Lógica de Preenchimento Automático
function autofill() {
    const nomeInput = document.getElementById('nome').value.toUpperCase().trim();
    const dados = tabelaPrecos[nomeInput];

    if (dados) {
        // Se encontrou o nome exato na lista
        document.getElementById('valor').value = dados.valor;
        document.getElementById('horas').value = dados.horas;
    } else {
        // Tentativa de busca parcial (caso o usuário digite "Betoneira" e existam várias)
        // Isso é opcional, mas ajuda se o usuário não selecionar da lista
        const match = Object.keys(tabelaPrecos).find(key => key.includes(nomeInput));
        if(match && nomeInput.length > 3) {
             document.getElementById('valor').value = tabelaPrecos[match].valor;
             document.getElementById('horas').value = tabelaPrecos[match].horas;
        }
    }
}

// Salva e Recarrega a Tabela
function addItem(){
    const item = {
        om: document.getElementById('om').value,
        patrimonio: document.getElementById('patrimonio').value,
        nome: document.getElementById('nome').value,
        preco: document.getElementById('preco').value, // Preço do Ativo (Manual)
        horas: document.getElementById('horas').value, // Vem da tabela
        valor: document.getElementById('valor').value, // Vem da tabela ($/OM)
        status: document.getElementById('status').value,
        obs: document.getElementById('obs').value
    };

    if(!item.nome) { alert("O nome da máquina é obrigatório."); return; }

    inventoryData.push(item);
    saveData();
    load();
    clearForm();
}

function saveData() {
    localStorage.setItem('oficina_inventory', JSON.stringify(inventoryData));
}

function clearForm() {
    document.getElementById('om').value = '';
    document.getElementById('patrimonio').value = '';
    document.getElementById('nome').value = '';
    document.getElementById('preco').value = '';
    document.getElementById('horas').value = '';
    document.getElementById('valor').value = '';
    document.getElementById('obs').value = '';
}

// --- LÓGICA DE SELEÇÃO E RENDERIZAÇÃO ---

function load(){
    const tbody = document.getElementById('lista');
    tbody.innerHTML = '';
    document.getElementById('selectAll').checked = false;

    inventoryData.forEach((item, index) => {
        const tr = document.createElement('tr');
        // Formata valores para moeda se existirem
        const precoFormatado = item.preco ? `R$ ${parseFloat(item.preco).toFixed(2)}` : '-';
        const valorFormatado = item.valor ? `R$ ${parseFloat(item.valor).toFixed(2)}` : '-';

        tr.innerHTML = `
            <td style="text-align: center;">
                <input type="checkbox" class="row-select" data-index="${index}">
            </td>
            <td>${item.om}</td>
            <td>${item.patrimonio}</td>
            <td>${item.nome}</td>
            <td>${precoFormatado}</td>
            <td>${item.horas}</td>
            <td>${valorFormatado}</td>
            <td>${item.status}</td>
            <td>${item.obs}</td>
        `;
        tbody.appendChild(tr);
    });
}

function toggleSelectAll(source) {
    const checkboxes = document.querySelectorAll('.row-select');
    checkboxes.forEach(cb => cb.checked = source.checked);
}

function getSelectedData() {
    const checkboxes = document.querySelectorAll('.row-select:checked');
    if (checkboxes.length === 0) {
        if(confirm("Nenhum item selecionado. Deseja exportar TODOS os itens?")) {
            return inventoryData;
        }
        return [];
    }
    const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.getAttribute('data-index')));
    return inventoryData.filter((_, index) => selectedIndices.includes(index));
}

function deleteSelected() {
    const checkboxes = document.querySelectorAll('.row-select:checked');
    if (checkboxes.length === 0) return alert("Selecione itens para excluir.");
    
    if(!confirm(`Tem certeza que deseja excluir ${checkboxes.length} itens?`)) return;

    const selectedIndices = Array.from(checkboxes)
        .map(cb => parseInt(cb.getAttribute('data-index')))
        .sort((a, b) => b - a);

    selectedIndices.forEach(index => {
        inventoryData.splice(index, 1);
    });

    saveData();
    load();
}

// --- EXPORTAÇÃO ---

function exportPDF(){
    const dataToExport = getSelectedData();
    if(dataToExport.length === 0) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.text("Inventário da Oficina - Remuneração Variável", 14, 15);
    
    const tableColumn = ["OM", "Patrimônio", "Nome", "Horas/OM", "Vlr. M.Obra", "Status"];
    const tableRows = [];

    dataToExport.forEach(item => {
        const rowData = [
            item.om,
            item.patrimonio,
            item.nome,
            item.horas,
            `R$ ${parseFloat(item.valor || 0).toFixed(2)}`,
            item.status
        ];
        tableRows.push(rowData);
    });

    doc.autoTable({
        head: [tableColumn],
        body: tableRows,
        startY: 20,
    });

    doc.save("inventario_oficina.pdf");
}

function exportExcel(){
    const dataToExport = getSelectedData();
    if(dataToExport.length === 0) return;

    const worksheet = XLSX.utils.json_to_sheet(dataToExport);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Inventário");

    XLSX.writeFile(workbook, "inventario_oficina.xlsx");
}

// Inicialização
populateOptions();
load();
</script>
</body>
</html>
