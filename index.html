<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Invent치rio da Oficina</title>
<style>
  body { font-family: Arial, sans-serif; background:#0f1720; color:#e6eef6; margin:0; padding:20px; }
  h1 { text-align:center; }
  .container { max-width:1000px; margin:0 auto; }
  .card { background:#14212d; padding:20px; border-radius:12px; margin-bottom:20px; }
  label { display:block; margin-top:10px; font-size:14px; }
  input, select, textarea { width:100%; padding:8px; border-radius:6px; border:1px solid #2a3a4d; background:#0d1a24; color:#e6eef6; box-sizing: border-box; }
  .row { display:flex; gap:12px; }
  .row > * { flex:1; }
  .inline { display:flex; gap:8px; align-items:center; }
  button { margin-top:15px; padding:10px 16px; border:none; border-radius:8px; cursor:pointer; background:#2b9cff; color:white; }
  button:hover { background:#1a8be0; }
  button.secondary { background: #2a3a4d; }
  /* Estilos para bot칫es de compartilhamento */
  button.share-btn { margin-top: 5px; } 
  button.share-pdf { background: #10b981; } /* Verde para PDF */
  button.share-pdf:hover { background: #059669; }
  button.share-excel { background: #eab308; } /* Amarelo para Excel */
  button.share-excel:hover { background: #d99905; }
  
  /* ESTILO NOVO: Bot칚o APK */
  button.btn-apk { background: #8e44ad; } /* Roxo */
  button.btn-apk:hover { background: #732d91; }
  
  .muted { color:#98a3b3; font-size:13px; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { padding:10px; border-bottom:1px solid #2a3a4d; text-align:left; }
  th { background:#1c2b38; }
  input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
  .top-actions { display:flex; gap:8px; align-items:center; margin-bottom:6px; flex-wrap: wrap; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
  <h1>Invent치rio da Oficina</h1>
  
  <div class="card">
    <h2>Adicionar M치quina</h2>
    <div class="row">
      <div>
        <label>OM</label>
        <input id="om" placeholder="N칰mero da OM" />
      </div>
      <div>
        <label>Patrim칪nio</label>
        <input id="patrimonio" placeholder="N칰mero do patrim칪nio" />
      </div>
    </div>
    <label>Nome da M치quina</label>
    <div class="inline">
      <input id="nome" list="equipamentosList" placeholder="Digite ou escolha..." onchange="autofill()" />
      <button id="autoFillBtn" type="button" class="secondary" onclick="autofill()">Auto preencher</button>
    </div>
    <datalist id="equipamentosList"></datalist>
    <div class="row">
      <div>
        <label>Pre칞o do Ativo (R$)</label>
        <input id="preco" type="number" step="any" placeholder="Valor de compra" />
      </div>
      <div>
        <label>Horas trabalhadas (Por OM)</label>
        <input id="horas" type="number" step="any" />
      </div>
    </div>
    <label>Valor da m칚o de obra (R$ / OM)</label>
    <input id="valor" type="number" step="any" />
    <label>Status</label>
    <select id="status">
      <option value="Dispon칤vel">Dispon칤vel</option>
      <option value="Aguardando pe칞a">Aguardando pe칞a</option>
      <option value="Em servi칞o">Em servi칞o</option>
    </select>
    <label>Observa칞칚o</label>
    <textarea id="obs" rows="3"></textarea>
    <button onclick="addItem()">Salvar M치quina</button>
  </div>

  <div class="card">
    <div class="top-actions">
      <div style="flex:1"><h2 style="margin:0">Invent치rio</h2></div>
      <div style="display:flex;gap:8px; flex-wrap:wrap;">
        
        <button onclick="downloadAPK()" class="btn-apk">游님 Baixar App</button>
        
        <button onclick="shareFile('pdf')" class="share-btn share-pdf">游닎 Compartilhar PDF</button>
        <button onclick="shareFile('excel')" class="share-btn share-excel">游닎 Compartilhar Excel</button>
        <button onclick="exportPDF()">Baixar PDF</button>
        <button onclick="exportExcel()">Baixar Excel</button>
        <button onclick="deleteSelected()" style="background:#d93025;">Excluir</button>
      </div>
    </div>
    <p class="muted">Selecione os itens na tabela para enviar, baixar ou excluir.</p>
    <table>
      <thead>
        <tr>
          <th style="width: 40px; text-align: center;">
            <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">
          </th>
          <th>OM</th>
          <th>Patrim칪nio</th>
          <th>Nome</th>
          <th>Pre칞o Ativo</th>
          <th>Horas/OM</th>
          <th>Vlr. M.Obra</th>
          <th>Status</th>
          <th>Obs</th>
        </tr>
      </thead>
      <tbody id="lista"></tbody>
    </table>
  </div>
</div>

<script>
// --- BANCO DE DADOS E L칍GICA ---
const tabelaPrecos = {
  "ACABADORA DE SUPERF": { valor: 2.00, horas: 5 },
  "BALANCIM CADEIRINHA": { valor: 2.00, horas: 2.25 },
  "BANCADA DE SERRA": { valor: 8.00, horas: 4.5 },
  "BETONEIRA 150 LT": { valor: 6.00, horas: 4.5 },
  "BETONEIRA 400LT": { valor: 6.00, horas: 4.5 },
  "BETONEIRA 600LT": { valor: 16.90, horas: 16 },
  "BOMBA MANGOTE": { valor: 4.00, horas: 3 },
  "BOMBA SUBMERSA": { valor: 4.00, horas: 4 },
  "COMPACTADOR": { valor: 3.00, horas: 4 },
  "CORTADORA": { valor: 3.00, horas: 4 },
  "GERADOR": { valor: 3.00, horas: 3.2 },
  "GUINCHO DE ELEVA칂츾O": { valor: 10.00, horas: 6 },
  "MARTELO 2 KG - 220V": { valor: 1.50, horas: 2 },
  "MARTELO 5,7 KG - 220V": { valor: 1.50, horas: 2 },
  "MARTELO 6 KG - 220V": { valor: 1.70, horas: 2 },
  "MARTELO 11 KG - ROT": { valor: 2.00, horas: 2.2 },
  "MARTELO 11 KG - 220V": { valor: 1.70, horas: 2.2 },
  "MARTELO 16/19 KG": { valor: 2.00, horas: 2.3 },
  "MARTELO 19 KG - 220V": { valor: 2.00, horas: 2.5 },
  "MARTELO 30 KG - 220V": { valor: 2.00, horas: 2.5 },
  "MINI GRUA": { valor: 10.00, horas: 6 },
  "MOTOR - ACIONADOR": { valor: 3.00, horas: 3 },
  "MOTOR - ELET_TRIFA": { valor: 3.00, horas: 3 },
  "PLACA VIBRATORIA": { valor: 3.50, horas: 4.5 },
  "REGUA VIBRATORIA": { valor: 5.00, horas: 4.5 },
  "TORRE DE ILUMINACAO": { valor: 25.00, horas: 6 },
  "UNIDADES HIDRAULICA": { valor: 8.00, horas: 16 },
  "VIBRADOR DE IMERSAO": { valor: 2.80, horas: 4 },
  "ROLO COMPACTADOR": { valor: 20.00, horas: 24 },
  "MINI CARREGADEIRA": { valor: 34.00, horas: 16 },
  "MINI ESCAVADEIRA": { valor: 34.00, horas: 16 },
  "VELOX": { valor: 8.00, horas: 6 },
  "PERFURATRIZ": { valor: 25.00, horas: 6 },
  "MAQUINA PESADA": { valor: 34.00, horas: 16 }
};

let inventoryData = JSON.parse(localStorage.getItem('oficina_inventory')) || [];

function populateOptions(){
    const datalist = document.getElementById('equipamentosList');
    datalist.innerHTML = '';
    Object.keys(tabelaPrecos).sort().forEach(item => {
        let option = document.createElement('option');
        option.value = item;
        datalist.appendChild(option);
    });
}

function autofill() {
    const nomeInput = document.getElementById('nome').value.toUpperCase().trim();
    const dados = tabelaPrecos[nomeInput];
    if (dados) {
        document.getElementById('valor').value = dados.valor;
        document.getElementById('horas').value = dados.horas;
    } else {
        const match = Object.keys(tabelaPrecos).find(key => key.includes(nomeInput));
        if(match && nomeInput.length > 3) {
             document.getElementById('valor').value = tabelaPrecos[match].valor;
             document.getElementById('horas').value = tabelaPrecos[match].horas;
        }
    }
}

function addItem(){
    const item = {
        om: document.getElementById('om').value,
        patrimonio: document.getElementById('patrimonio').value,
        nome: document.getElementById('nome').value,
        preco: document.getElementById('preco').value,
        horas: document.getElementById('horas').value,
        valor: document.getElementById('valor').value,
        status: document.getElementById('status').value,
        obs: document.getElementById('obs').value
    };
    if(!item.nome) { alert("O nome da m치quina 칠 obrigat칩rio."); return; }
    inventoryData.push(item);
    saveData();
    load();
    clearForm();
}

function saveData() { localStorage.setItem('oficina_inventory', JSON.stringify(inventoryData)); }
function clearForm() {
    document.getElementById('om').value = '';
    document.getElementById('patrimonio').value = '';
    document.getElementById('nome').value = '';
    document.getElementById('preco').value = '';
    document.getElementById('horas').value = '';
    document.getElementById('valor').value = '';
    document.getElementById('obs').value = '';
}

function load(){
    const tbody = document.getElementById('lista');
    tbody.innerHTML = '';
    document.getElementById('selectAll').checked = false;
    inventoryData.forEach((item, index) => {
        const tr = document.createElement('tr');
        const precoFormatado = item.preco ? `R$ ${parseFloat(item.preco).toFixed(2)}` : '-';
        const valorFormatado = item.valor ? `R$ ${parseFloat(item.valor).toFixed(2)}` : '-';
        tr.innerHTML = `
            <td style="text-align: center;"><input type="checkbox" class="row-select" data-index="${index}"></td>
            <td>${item.om}</td>
            <td>${item.patrimonio}</td>
            <td>${item.nome}</td>
            <td>${precoFormatado}</td>
            <td>${item.horas}</td>
            <td>${valorFormatado}</td>
            <td>${item.status}</td>
            <td>${item.obs}</td>
        `;
        tbody.appendChild(tr);
    });
}

function toggleSelectAll(source) {
    document.querySelectorAll('.row-select').forEach(cb => cb.checked = source.checked);
}

function getSelectedData() {
    const checkboxes = document.querySelectorAll('.row-select:checked');
    if (checkboxes.length === 0) {
        if(confirm("Deseja selecionar TODOS os itens?")) return inventoryData;
        return [];
    }
    const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.getAttribute('data-index')));
    return inventoryData.filter((_, index) => selectedIndices.includes(index));
}

function deleteSelected() {
    const checkboxes = document.querySelectorAll('.row-select:checked');
    if (checkboxes.length === 0) return alert("Selecione itens para excluir.");
    if(!confirm(`Excluir ${checkboxes.length} itens?`)) return;
    const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.getAttribute('data-index'))).sort((a, b) => b - a);
    selectedIndices.forEach(index => inventoryData.splice(index, 1));
    saveData();
    load();
}

// --- FUN칂칏ES AUXILIARES DE GERA칂츾O (PDF e EXCEL) ---

function generatePDFDoc(data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Invent치rio da Oficina - Remunera칞칚o Vari치vel", 14, 15);
    const tableColumn = ["OM", "Patrim칪nio", "Nome", "Horas/OM", "Vlr. M.Obra", "Status"];
    const tableRows = data.map(item => [
        item.om, item.patrimonio, item.nome, item.horas, 
        `R$ ${parseFloat(item.valor || 0).toFixed(2)}`, item.status
    ]);
    doc.autoTable({ head: [tableColumn], body: tableRows, startY: 20 });
    return doc;
}

function generateExcelBlob(data) {
    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Invent치rio");
    const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'binary' });

    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }
    const arrayBuffer = s2ab(wbout);

    return new Blob([arrayBuffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
}

// --- FUN칂칏ES DE DOWNLOAD (Mantidas para o fallback) ---
function exportPDF(){
    const data = getSelectedData();
    if(data.length === 0) return;
    const doc = generatePDFDoc(data);
    doc.save("inventario_oficina.pdf");
}

function exportExcel(){
    const data = getSelectedData();
    if(data.length === 0) return;
    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Invent치rio");
    XLSX.writeFile(workbook, "inventario_oficina.xlsx");
}

// --- FUN칂츾O CORRIGIDA DE COMPARTILHAMENTO ---
async function shareFile(type) {
    const data = getSelectedData();
    if(data.length === 0) return;

    let file, filename, mimeType, title, text;

    try {
        if (type === 'pdf') {
            const doc = generatePDFDoc(data);
            const blob = doc.output('blob');
            filename = "inventario.pdf";
            mimeType = "application/pdf";
            title = 'Invent치rio da Oficina (PDF)';
            text = 'Segue em anexo o relat칩rio de invent치rio em PDF.';
            file = new File([blob], filename, { type: mimeType });
        } else if (type === 'excel') {
            const blob = generateExcelBlob(data);
            filename = "inventario.xlsx";
            mimeType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
            title = 'Invent치rio da Oficina (Excel)';
            text = 'Segue em anexo o relat칩rio de invent치rio em formato Excel.';
            file = new File([blob], filename, { type: mimeType });
        } else {
            return; 
        }

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({ title, text, files: [file] });
        } else {
            alert(`ATEN칂츾O: Compartilhamento indispon칤vel no seu navegador/dispositivo. Por seguran칞a, navegadores n칚o permitem que o site envie e-mails diretamente com arquivos.\n\nO arquivo (${filename}) ser치 **baixado automaticamente** e voc칡 dever치 anex치-lo manualmente no seu e-mail.`);
            
            if (type === 'pdf') {
                exportPDF();
            } else {
                exportExcel();
            }
        }
    } catch (error) {
        console.error("Erro ou cancelamento no compartilhamento:", error);
        alert(`Ocorreu um erro ou o compartilhamento foi cancelado. O arquivo ser치 baixado para que voc칡 possa anex치-lo manualmente.`);
        
        if (type === 'pdf') {
            exportPDF();
        } else {
            exportExcel();
        }
    }
}

// --- FUN칂츾O PARA BAIXAR APK DO GITHUB ---
function downloadAPK() {
    // Link corrigido para baixar direto (RAW)
    const linkGithub = "https://github.com/jeosafa123/SVROM/raw/main/VSROM.apk";
    
    // Abre em nova aba para for칞ar o download
    window.open(linkGithub, '_blank');
}

// Inicializa칞칚o
populateOptions();
load();
</script>
</body>
  </html>
