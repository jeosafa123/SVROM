<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Oficina Pro - PWA</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f1720">

<style>
/* Estiliza√ß√£o Geral Otimizada */
body { font-family: 'Segoe UI', sans-serif; background:#0f1720; color:#e6eef6; margin:0; padding:15px; }
.container { max-width:1100px; margin:0 auto; padding-bottom: 50px; }
h1 { text-align:center; color: #2b9cff; font-size: 1.4rem; margin-bottom: 20px; }

/* Abas */
.tab-container { display: flex; border-bottom: 2px solid #2a3a4d; margin-bottom: 20px; gap: 5px; }
.tab-button {
  background: #14212d; color: #98a3b3; border: none; padding: 12px; flex: 1;
  cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; transition: 0.3s;
}
.tab-button.active { background: #2b9cff; color: white; }
.tab-content { display: none; animation: fadeIn 0.3s; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* Cards */
.card { background:#14212d; padding:20px; border-radius:12px; margin-bottom:15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
label { display:block; margin-top:10px; font-weight: 600; color: #a0aec0; font-size: 0.85rem; }
input, select {
  width:100%; padding:12px; border-radius:6px;
  border:1px solid #2a3a4d; background:#0d1a24; color:#fff;
  box-sizing: border-box; margin-top: 5px; font-size: 16px;
}
.row { display:flex; gap:10px; flex-wrap: wrap; }
.row > * { flex:1; min-width: 130px; }

/* Bot√µes */
button { padding:12px; border:none; border-radius:8px; cursor:pointer; font-weight: bold; transition: 0.2s; font-size: 14px; }
.btn-main { background:#2b9cff; color: white; width: 100%; margin-top: 15px; padding: 15px; font-size: 1rem; }
.btn-red { background:#dc2626; color: white; }
.btn-blue { background:#2563eb; color: white; }
.btn-share { background:#8b5cf6; color: white; }
.btn-sync { background:#0ea5e9; color: white; }

/* Tabela Responsiva */
.table-responsive { width: 100%; overflow-x: auto; border-radius: 8px; border: 1px solid #2a3a4d; margin-top: 10px; }
table { width:100%; border-collapse:collapse; background: #0d1a24; min-width: 500px; }
th, td { padding:10px; border-bottom: 1px solid #2a3a4d; text-align: left; font-size: 13px; }
th { background:#1c2b38; color: #2b9cff; text-transform: uppercase; font-size: 10px; }

/* Stats */
.stat-box { background:#0d1a24; padding:12px; border-radius:8px; text-align: center; border: 1px solid #2a3a4d; flex: 1; }
.stat-val { font-size: 1.4em; font-weight: bold; color: #4ade80; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
<div class="container">
  <h1>Sistema Oficina v6.2</h1>

  <div class="tab-container">
    <button class="tab-button active" onclick="openTab('tab-entrada', this)">üìù Lan√ßamento</button>
    <button class="tab-button" onclick="openTab('tab-inventario', this)">üìã Hist√≥rico</button>
  </div>

  <div id="tab-entrada" class="tab-content active">
    <div class="card">
      <div class="row">
        <div><label>OM</label><input id="om" type="tel" placeholder="N¬∫ Ordem"></div>
        <div><label>Patrim√¥nio</label><input id="patrimonio" type="tel" placeholder="C√≥digo"></div>
      </div>
      <label>Equipamento</label>
      <select id="nome" onchange="autoPreencher()">
        <option value="">-- Selecione --</option>
      </select>
      <div class="row">
        <div><label>Horas</label><input id="horas" type="number" step="0.01"></div>
        <div><label>Valor Unit.</label><input id="valor" type="number" step="0.01"></div>
      </div>
      <button class="btn-main" onclick="addItem()">SALVAR NO DISPOSITIVO</button>
    </div>
    
    <div class="row">
      <div class="stat-box">
        <div style="color:#98a3b3; font-size:0.7rem;">HORAS ACUMULADAS</div>
        <div id="totalHorasEntrada" class="stat-val">0.00</div>
      </div>
      <div class="stat-box">
        <div style="color:#98a3b3; font-size:0.7rem;">CUSTO ESTIMADO</div>
        <div id="totalValorEntrada" class="stat-val">R$ 0,00</div>
      </div>
    </div>
  </div>

  <div id="tab-inventario" class="tab-content">
    <div class="card">
      <div class="row" style="margin-bottom: 15px;">
        <button onclick="shareFile('pdf')" class="btn-share" style="flex:1">PDF</button>
        <button onclick="shareFile('excel')" class="btn-share" style="flex:1">EXCEL</button>
        <button onclick="exportBackup()" class="btn-blue" style="flex:1">BACKUP</button>
      </div>

      <input type="text" id="searchInput" placeholder="üîç Pesquisar..." onkeyup="load()">

      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th style="width:20px"><input type="checkbox" onclick="toggleAll(this)"></th>
              <th>OM</th>
              <th>Equipamento</th>
              <th>Horas</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="lista"></tbody>
        </table>
      </div>
      <button onclick="deleteSelected()" class="btn-red" style="width:100%; margin-top:15px;">üóëÔ∏è EXCLUIR SELECIONADOS</button>
    </div>
  </div>
</div>

<script>
/* --- DADOS E MIGRA√á√ÉO --- */
const tabelaPrecos = [
  { nome: "ACABADORA DE SUPERFICIE", valor: 2.00, horas: 5.0 },
  { nome: "BETONEIRA 400 LT", valor: 6.00, horas: 4.5 },
  { nome: "COMPACTADOR", valor: 3.00, horas: 4.0 },
  { nome: "GERADOR", valor: 3.00, horas: 3.2 },
  { nome: "MARTELO 11 KG - 220V", valor: 1.70, horas: 2.2 },
  { nome: "VIBRADOR DE IMERS√ÉO", valor: 2.80, horas: 4.0 },
  { nome: "ROLO COMPACTADOR", valor: 20.00, horas: 24.0 }
  // ... adicione os outros aqui conforme necess√°rio
];

// Preencher Select
const select = document.getElementById("nome");
tabelaPrecos.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(i=>select.innerHTML+=`<option value="${i.nome}">${i.nome}</option>`);

// L√≥gica de Migra√ß√£o Inteligente
let inventoryData = [];
const currentKey = "oficina_inventory_v6.2";
const oldKeys = ["oficina_inventory_v6", "oficina_inventory", "oficina_v4"];

function initData() {
    const saved = localStorage.getItem(currentKey);
    if (saved) {
        inventoryData = JSON.parse(saved);
    } else {
        // Busca em chaves antigas
        for (let key of oldKeys) {
            const old = localStorage.getItem(key);
            if (old) {
                const parsed = JSON.parse(old);
                inventoryData = parsed.map(i => ({
                    id: i.id || Date.now() + Math.random(),
                    om: i.om || i.ordem || '',
                    patrimonio: i.patrimonio || '',
                    nome: i.nome || i.equipamento || '',
                    horas: Number(i.horas || 0),
                    valor: Number(i.valor || i.preco || 0)
                }));
                localStorage.setItem(currentKey, JSON.stringify(inventoryData));
                alert("Dados de vers√µes anteriores migrados!");
                break;
            }
        }
    }
}

function saveData() { localStorage.setItem(currentKey, JSON.stringify(inventoryData)); }

/* --- FUNCIONALIDADES --- */
function openTab(id, btn) {
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
}

function autoPreencher() {
  const item = tabelaPrecos.find(i=>i.nome===select.value);
  if(item){
    document.getElementById("horas").value = item.horas;
    document.getElementById("valor").value = item.valor.toFixed(2);
  }
}

function addItem() {
  const om = document.getElementById("om").value;
  const nome = select.value;
  if(!om || !nome) return alert("Preencha OM e Equipamento");

  inventoryData.push({
    id: Date.now(),
    om: om,
    patrimonio: document.getElementById("patrimonio").value,
    nome: nome,
    horas: Number(document.getElementById("horas").value),
    valor: Number(document.getElementById("valor").value)
  });
  saveData(); load();
  document.getElementById("patrimonio").value = "";
  alert("Salvo!");
}

function load() {
  const termo = document.getElementById("searchInput").value.toLowerCase();
  const tbody = document.getElementById("lista");
  tbody.innerHTML = "";
  let th=0, tv=0;

  inventoryData.forEach(i => {
    if(termo && !`${i.om} ${i.nome}`.toLowerCase().includes(termo)) return;
    th += i.horas; tv += (i.horas * i.valor);
    tbody.innerHTML += `<tr>
      <td><input type="checkbox" class="row-select" data-id="${i.id}"></td>
      <td>${i.om}</td>
      <td>${i.nome}</td>
      <td>${i.horas.toFixed(2)}</td>
      <td>R$ ${(i.horas*i.valor).toFixed(2)}</td>
    </tr>`;
  });
  document.getElementById("totalHorasEntrada").innerText = th.toFixed(2);
  document.getElementById("totalValorEntrada").innerText = "R$ " + tv.toFixed(2);
}

function toggleAll(src) { document.querySelectorAll(".row-select").forEach(c=>c.checked=src.checked); }

function deleteSelected() {
  const checks = document.querySelectorAll(".row-select:checked");
  if(!checks.length || !confirm("Excluir?")) return;
  const ids = Array.from(checks).map(c=>Number(c.dataset.id));
  inventoryData = inventoryData.filter(i=>!ids.includes(i.id));
  saveData(); load();
}

/* --- EXPORTA√á√ÉO E PONTE --- */
function sendFile(blob, filename) {
  const reader = new FileReader();
  reader.onloadend = () => {
    const base64 = reader.result.split(',')[1];
    if (window.Android && window.Android.downloadFile) {
        window.Android.downloadFile(base64, filename);
    } else {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
    }
  };
  reader.readAsDataURL(blob);
}

function shareFile(type) {
  if (type === 'pdf') {
    const doc = new jspdf.jsPDF();
    doc.text("Relat√≥rio Oficina", 10, 10);
    const rows = inventoryData.map(i=>[i.om, i.nome, i.horas, (i.horas*i.valor).toFixed(2)]);
    doc.autoTable({ head: [['OM', 'Item', 'Horas', 'Total']], body: rows });
    sendFile(doc.output('blob'), 'oficina.pdf');
  } else {
    const ws = XLSX.utils.json_to_sheet(inventoryData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Dados");
    const out = XLSX.write(wb, { type: 'array', bookType: 'xlsx' });
    sendFile(new Blob([out]), 'oficina.xlsx');
  }
}

function exportBackup() {
    const blob = new Blob([JSON.stringify(inventoryData)], {type: 'application/json'});
    sendFile(blob, 'backup_oficina.json');
}

// Registro do Service Worker para PWA
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(()=>console.log("PWA Ativo"));
}

initData();
load();
</script>
</body>
</html>