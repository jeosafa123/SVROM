<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema Oficina - Profissional v6</title>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f1720">

<style>
/* Estiliza√ß√£o Geral */
body { font-family: 'Segoe UI', sans-serif; background:#0f1720; color:#e6eef6; margin:0; padding:20px; }
.container { max-width:1100px; margin:0 auto; }
h1 { text-align:center; color: #2b9cff; margin-bottom: 30px; }

/* Sistema de Abas */
.tab-container { display: flex; border-bottom: 2px solid #2a3a4d; margin-bottom: 20px; gap: 5px; }
.tab-button {
  background: #14212d; color: #98a3b3; border: none; padding: 12px 25px;
  cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; transition: 0.3s;
}
.tab-button.active { background: #2b9cff; color: white; }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Cards e Forms */
.card { background:#14212d; padding:25px; border-radius:12px; margin-bottom:20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
label { display:block; margin-top:12px; font-weight: 600; color: #a0aec0; }
input, select {
  width:100%; padding:12px; border-radius:6px;
  border:1px solid #2a3a4d; background:#0d1a24; color:#fff;
  box-sizing: border-box; margin-top: 5px; font-size: 15px;
}
.row { display:flex; gap:15px; flex-wrap: wrap; }
.row > * { flex:1; min-width: 200px; }

/* Bot√µes */
button { padding:12px 20px; border:none; border-radius:8px; cursor:pointer; font-weight: bold; transition: 0.2s; }
.btn-main { background:#2b9cff; color: white; width: 100%; margin-top: 20px; font-size: 16px; }
.btn-red { background:#dc2626; color: white; }
.btn-green { background:#16a34a; color: white; }
.btn-blue { background:#2563eb; color: white; }
.btn-share { background:#8b5cf6; color: white; }
.btn-sync { background:#0ea5e9; color: white; }

/* Tabela */
table { width:100%; border-collapse:collapse; margin-top:15px; background: #0d1a24; border-radius: 8px; overflow: hidden; }
th, td { padding:15px; border-bottom: 1px solid #2a3a4d; text-align: left; }
th { background:#1c2b38; color: #2b9cff; text-transform: uppercase; font-size: 11px; }

/* Dashboard */
.stat-box { background:#0d1a24; padding:15px; border-radius:8px; text-align: center; border: 1px solid #2a3a4d; }
.stat-val { font-size: 1.8em; font-weight: bold; color: #4ade80; }
</style>

<!-- Bibliotecas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
<div class="container">
  <h1>Gest√£o Oficina Mec√¢nica</h1>

  <div class="tab-container">
    <button class="tab-button active" onclick="openTab('tab-entrada', this)">üìù Lan√ßamento</button>
    <button class="tab-button" onclick="openTab('tab-inventario', this)">üìã Banco de Dados</button>
  </div>

  <div id="tab-entrada" class="tab-content active">
    <div class="card">
      <h2>Novo Registro</h2>
      <div class="row">
        <div><label>OM</label><input id="om" placeholder="Ex: 198"></div>
        <div><label>Patrim√¥nio</label><input id="patrimonio" placeholder="Ex: 102030"></div>
      </div>
      <label>Equipamento (Tabela Autom√°tica)</label>
      <select id="nome" onchange="autoPreencher()">
        <option value="">-- Selecione o item --</option>
      </select>
      <div class="row">
        <div><label>Horas</label><input id="horas" type="number" step="0.01"></div>
        <div><label>Valor Unit√°rio (R$)</label><input id="valor" type="number" step="0.01"></div>
      </div>
      <button class="btn-main" onclick="addItem()">ADICIONAR AO INVENT√ÅRIO</button>
    </div>
    
    <div class="card">
      <div class="row">
        <div class="stat-box">
          <div style="color:#98a3b3;">Horas Acumuladas</div>
          <div id="totalHorasEntrada" class="stat-val" style="color:#fff">0.00</div>
        </div>
        <div class="stat-box">
          <div style="color:#98a3b3;">Custo Acumulado</div>
          <div id="totalValorEntrada" class="stat-val">R$ 0,00</div>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-inventario" class="tab-content">
    <div class="card">
      <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px;">
        <button id="btnPdf" onclick="shareFile('pdf')" class="btn-share">üì§ PDF</button>
        <button id="btnExcel" onclick="shareFile('excel')" class="btn-share">üì§ Excel</button>
        <button onclick="syncData()" class="btn-sync">‚òÅÔ∏è Sincronizar Nuvem</button>
        <button onclick="exportBackupMensal()" class="btn-blue">üì• Backup</button>
        <label class="btn-blue" style="padding: 10px 15px; border-radius: 8px; cursor: pointer;">
          ‚ôªÔ∏è Importar <input type="file" accept=".json" hidden onchange="importBackupMensal(event)">
        </label>
        <button onclick="deleteSelected()" class="btn-red" style="margin-left: auto;">üóëÔ∏è Excluir</button>
      </div>

      <input type="text" id="searchInput" placeholder="üîç Pesquisar..." onkeyup="load()" style="margin-bottom: 15px; border: 1px solid #2b9cff;">

      <table>
        <thead>
          <tr>
            <th style="width: 20px;"><input type="checkbox" onclick="toggleAll(this)"></th>
            <th>OM</th>
            <th>Patrim√¥nio</th>
            <th>Equipamento</th>
            <th>Horas</th>
            <th>Valor</th>
          </tr>
        </thead>
        <tbody id="lista"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* DADOS DO BANCO */
const tabelaPrecos = [
  { nome: "ACABADORA DE SUPERFICIE", valor: 2.00, horas: 5.0 },
  { nome: "BALANCIM CADEIRINHA", valor: 2.00, horas: 2.25 },
  { nome: "BANCADA DE SERRA", valor: 8.00, horas: 4.5 },
  { nome: "BETONEIRA 150 LT", valor: 6.00, horas: 4.5 },
  { nome: "BETONEIRA 400 LT", valor: 6.00, horas: 4.5 },
  { nome: "BETONEIRA 600 LT", valor: 16.90, horas: 16.0 },
  { nome: "BOMBA MANGOTE", valor: 4.00, horas: 3.0 },
  { nome: "BOMBA SUBMERSA", valor: 4.00, horas: 4.0 },
  { nome: "COMPACTADOR", valor: 3.00, horas: 4.0 },
  { nome: "CORTADORA", valor: 3.00, horas: 4.0 },
  { nome: "GERADOR", valor: 3.00, horas: 3.2 },
  { nome: "GUINCHO DE ELEVA√á√ÉO", valor: 10.00, horas: 6.0 },
  { nome: "MARTELO 2 KG - 220V", valor: 1.50, horas: 2.0 },
  { nome: "MARTELO 5,7 KG - 220V", valor: 1.50, horas: 2.0 },
  { nome: "MARTELO 6 KG - 220V", valor: 1.70, horas: 2.0 },
  { nome: "MARTELO 11 KG - ROT", valor: 2.00, horas: 2.2 },
  { nome: "MARTELO 11 KG - 220V", valor: 1.70, horas: 2.2 },
  { nome: "MARTELO 16/19 KG", valor: 2.00, horas: 2.3 },
  { nome: "MARTELO 19 KG - 220V", valor: 2.00, horas: 2.5 },
  { nome: "MARTELO 30 KG - 220V", valor: 2.00, horas: 2.5 },
  { nome: "MINI GRUA", valor: 10.00, horas: 6.0 },
  { nome: "MOTOR - ACIONADOR", valor: 3.00, horas: 3.0 },
  { nome: "MOTOR - ELET TRIFA", valor: 3.00, horas: 3.0 },
  { nome: "PLACA VIBRATORIA", valor: 3.50, horas: 4.5 },
  { nome: "R√âGUA VIBRAT√ìRIA", valor: 5.00, horas: 4.5 },
  { nome: "TORRE DE ILUMINA√á√ÉO", valor: 25.00, horas: 6.0 },
  { nome: "UNIDADE HIDR√ÅULICA", valor: 8.00, horas: 16.0 },
  { nome: "VIBRADOR DE IMERS√ÉO", valor: 2.80, horas: 4.0 },
  { nome: "ROLO COMPACTADOR (Pesada)", valor: 20.00, horas: 24.0 },
  { nome: "MINI CARREGADEIRA (Pesada)", valor: 34.00, horas: 16.0 },
  { nome: "MINI ESCAVADEIRA (Pesada)", valor: 34.00, horas: 16.0 },
  { nome: "VELOX", valor: 8.00, horas: 6.0 },
  { nome: "PERFURATRIZ", valor: 25.00, horas: 6.0 }
];

const select = document.getElementById("nome");
tabelaPrecos.forEach(i => select.innerHTML += `<option value="${i.nome}">${i.nome}</option>`);

/* Abre abas de interface */
function openTab(tabId, btn) {
  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  if (btn) btn.classList.add('active');
}

/* Auto preencher ao selecionar equipamento */
function autoPreencher() {
  const item = tabelaPrecos.find(i => i.nome === select.value);
  if (item) {
    document.getElementById("horas").value = item.horas;
    document.getElementById("valor").value = item.valor.toFixed(2);
  }
}

/* INICIALIZA√á√ÉO DE DADOS (carrega e normaliza) */
let inventoryDataRaw = JSON.parse(localStorage.getItem("oficina_inventory")) ||
                       JSON.parse(localStorage.getItem("oficina_v4")) || [];
let inventoryData = (inventoryDataRaw || []).map(i => ({
  om: i?.om || '',
  patrimonio: i?.patrimonio || '',
  nome: i?.nome || '',
  horas: Number(i?.horas) || 0,
  valor: Number(i?.valor) || 0
}));

/* Salva dados normalizados */
function saveData() {
  localStorage.setItem("oficina_inventory", JSON.stringify(inventoryData));
}

/* Adiciona item */
function addItem() {
  const item = {
    om: (document.getElementById("om").value || '').toString(),
    patrimonio: (document.getElementById("patrimonio").value || '').toString(),
    nome: select.value || '',
    horas: Number(document.getElementById("horas").value) || 0,
    valor: Number(document.getElementById("valor").value) || 0
  };

  if (!item.om || !item.nome) {
    return alert("Campos OM e Nome s√£o obrigat√≥rios! Por favor, preencha todos os campos.");
  }

  inventoryData.push(item);
  saveData();
  load();
  alert("Item salvo!");
}

/* Carrega a lista e calcula totais (horas somam; total valor = horas * valorUnit) */
function load() {
  const termo = (document.getElementById("searchInput").value || '').toLowerCase();
  const tbody = document.getElementById("lista");
  tbody.innerHTML = "";
  let th = 0, tv = 0;

  inventoryData.forEach((i, idx) => {
    if (termo && !`${i.om} ${i.patrimonio} ${i.nome}`.toLowerCase().includes(termo)) return;

    const horasNum = Number(i.horas) || 0;
    const valorUnit = Number(i.valor) || 0;
    th += horasNum;
    tv += horasNum * valorUnit;

    tbody.innerHTML += `<tr>
      <td><input type="checkbox" class="row-select" data-index="${idx}"></td>
      <td>${i.om}</td>
      <td>${i.patrimonio}</td>
      <td>${i.nome}</td>
      <td>${(Number(i.horas) || 0).toFixed(2)}</td>
      <td>R$ ${Number(i.valor || 0).toFixed(2)}</td>
    </tr>`;
  });

  document.getElementById("totalHorasEntrada").innerText = th.toFixed(2);
  document.getElementById("totalValorEntrada").innerText = "R$ " + tv.toFixed(2);
  console.log("Dados carregados:", inventoryData.length, "TotalHoras:", th, "TotalValor:", tv);
}

function deleteSelected() {
  const checks = document.querySelectorAll(".row-select:checked");
  if (!checks.length || !confirm("Excluir?")) return;
  const idxs = Array.from(checks).map(c => parseInt(c.getAttribute('data-index'))).sort((a, b) => b - a);
  idxs.forEach(i => inventoryData.splice(i, 1));
  saveData();
  load();
}

function toggleAll(source) {
  document.querySelectorAll(".row-select").forEach(c => c.checked = source.checked);
}

/* ------------------ EXPORTA√á√ÉO (PDF / EXCEL) e envio para native ------------------ */

/* Fun√ß√£o principal chamada pelos bot√µes */
function shareFile(type) {
  console.log('shareFile chamado:', type);
  if (type === 'pdf') return generatePDF();
  if (type === 'excel') return generateExcel();
  alert('Formato n√£o suportado: ' + type);
}

/* Envia Blob para o app nativo em base64 (se existir bridge), sen√£o fallback download */
function sendBlobToNativeOrDownload(blob, filename) {
  const reader = new FileReader();
  reader.onloadend = () => {
    const dataUrl = reader.result; // data:...;base64,...
    const base64 = dataUrl.split(',')[1];

    // Android bridge (Java): window.Android.downloadFile(base64, filename);
    if (window.Android && typeof window.Android.downloadFile === 'function') {
      try {
        console.log('Enviando arquivo para bridge Android:', filename);
        window.Android.downloadFile(base64, filename);
        return;
      } catch (e) {
        console.warn('Erro ao chamar Android.downloadFile:', e);
      }
    }

    // iOS bridge (WKWebView)
    if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.download) {
      try {
        console.log('Enviando arquivo para iOS bridge via messageHandlers.download');
        window.webkit.messageHandlers.download.postMessage({ filename: filename, data: base64 });
        return;
      } catch (e) {
        console.warn('Erro ao postar mensagem para iOS bridge:', e);
      }
    }

    // fallback: tentativa de download via link (muitos WebViews bloqueiam)
    try {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      console.log('Fallback download acionado:', filename);
    } catch (e) {
      console.error('Fallback download falhou:', e);
      alert('N√£o foi poss√≠vel salvar o arquivo neste WebView. Se voc√™ controla o app Android, implemente a ponte nativa (Android) para receber o arquivo base64 e salv√°-lo.');
    }
  };
  reader.onerror = (err) => {
    console.error('Erro lendo blob para base64:', err);
    alert('Erro ao preparar o arquivo para download.');
  };
  reader.readAsDataURL(blob);
}

/* Gera PDF com jsPDF + autoTable (com fallback textual se plugin n√£o estiver registrado) */
async function generatePDF() {
  try {
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) throw new Error('jsPDF n√£o encontrado');
    const doc = new jsPDF();
    doc.setFontSize(14);
    doc.text('Invent√°rio - Oficina', 14, 12);

    const head = [['OM','Patrim√¥nio','Equipamento','Horas','Valor (R$)']];
    const body = inventoryData.map(i => [
      i.om || '',
      i.patrimonio || '',
      i.nome || '',
      (Number(i.horas)||0).toFixed(2),
      (Number(i.valor)||0).toFixed(2)
    ]);

    if (typeof doc.autoTable === 'function') {
      doc.autoTable({ head, body, startY: 18, styles: { fontSize: 9 } });
    } else {
      // fallback textual simples
      let y = 18;
      doc.setFontSize(10);
      head[0].forEach((h, idx) => doc.text(String(h), 14 + idx*36, y));
      y += 6;
      body.forEach(row => {
        row.forEach((cell, idx) => doc.text(String(cell), 14 + idx*36, y));
        y += 6;
        if (y > 280) { doc.addPage(); y = 20; }
      });
    }

    const pdfBlob = doc.output('blob');
    sendBlobToNativeOrDownload(pdfBlob, 'inventario.pdf');
  } catch (err) {
    console.error('Erro ao gerar PDF:', err);
    alert('Erro ao gerar PDF. Veja console.');
  }
}

/* Gera Excel com SheetJS (XLSX) */
function generateExcel() {
  try {
    const ws_data = [
      ['OM','Patrim√¥nio','Equipamento','Horas','Valor (R$)'],
      ...inventoryData.map(i => [
        i.om || '',
        i.patrimonio || '',
        i.nome || '',
        Number(i.horas) || 0,
        Number(i.valor) || 0
      ])
    ];

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, 'Invent√°rio');

    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    sendBlobToNativeOrDownload(blob, 'inventario.xlsx');
  } catch (err) {
    console.error('Erro ao gerar Excel:', err);
    alert('Erro ao gerar Excel. Veja console.');
  }
}

/* Stubs / utilit√°rios para outras a√ß√µes */
function syncData() { alert('syncData() n√£o implementada ainda.'); }
function exportBackupMensal() { alert('exportBackupMensal() n√£o implementada ainda.'); }
function importBackupMensal(event) {
  const file = event.target.files && event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      inventoryData = (data || []).map(i => ({
        om: i?.om || '',
        patrimonio: i?.patrimonio || '',
        nome: i?.nome || '',
        horas: Number(i?.horas) || 0,
        valor: Number(i?.valor) || 0
      }));
      saveData();
      load();
      alert('Importa√ß√£o conclu√≠da');
    } catch (e) {
      console.error('Erro importando JSON:', e);
      alert('Arquivo JSON inv√°lido.');
    }
  };
  reader.readAsText(file);
}

/* Inicializa a tela */
load();
</script>
</body>
</html>
