<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Gest√£o Oficina Pro v6.4</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f1720">

<style>
/* --- Estiliza√ß√£o Geral (PRESERVADA) --- */
body { font-family: 'Segoe UI', sans-serif; background:#0f1720; color:#e6eef6; margin:0; padding:15px; }
.container { max-width:1100px; margin:0 auto; padding-bottom: 50px; }
h1 { text-align:center; color: #2b9cff; margin-bottom: 20px; font-size: 1.5rem; }

/* --- Sistema de Abas --- */
.tab-container { display: flex; border-bottom: 2px solid #2a3a4d; margin-bottom: 20px; gap: 5px; }
.tab-button {
  background: #14212d; color: #98a3b3; border: none; padding: 12px 20px; flex: 1;
  cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; transition: 0.3s;
}
.tab-button.active { background: #2b9cff; color: white; }
.tab-content { display: none; animation: fadeIn 0.3s; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* --- Cards e Forms --- */
.card { background:#14212d; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
label { display:block; margin-top:12px; font-weight: 600; color: #a0aec0; font-size: 0.9rem; }
input, select {
  width:100%; padding:12px; border-radius:6px;
  border:1px solid #2a3a4d; background:#0d1a24; color:#fff;
  box-sizing: border-box; margin-top: 5px; font-size: 16px; 
}
.row { display:flex; gap:15px; flex-wrap: wrap; }
.row > * { flex:1; min-width: 140px; }

/* --- Bot√µes --- */
button { padding:12px 20px; border:none; border-radius:8px; cursor:pointer; font-weight: bold; transition: 0.2s; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
button:active { transform: scale(0.98); }
.btn-main { background:#2b9cff; color: white; width: 100%; margin-top: 20px; font-size: 16px; padding: 15px; }
.btn-red { background:#dc2626; color: white; }
.btn-blue { background:#2563eb; color: white; }
.btn-share { background:#8b5cf6; color: white; }
.btn-sync { background:#0ea5e9; color: white; }
.btn-import { background:#2563eb; color: white; display: inline-flex; align-items: center; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; gap: 5px;}

/* --- Tabela e Dashboard --- */
.table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; border: 1px solid #2a3a4d; }
table { width:100%; border-collapse:collapse; background: #0d1a24; min-width: 600px; }
th, td { padding:12px; border-bottom: 1px solid #2a3a4d; text-align: left; }
th { background:#1c2b38; color: #2b9cff; text-transform: uppercase; font-size: 11px; white-space: nowrap; }

.stat-box { background:#0d1a24; padding:15px; border-radius:8px; text-align: center; border: 1px solid #2a3a4d; flex: 1; }
.stat-val { font-size: 1.6em; font-weight: bold; color: #4ade80; margin-top: 5px; }

.meses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-top: 10px; }
.mes-card { background: #1c2b38; padding: 10px; border-radius: 8px; border-left: 4px solid #2b9cff; }
.mes-nome { font-size: 0.75rem; color: #a0aec0; text-transform: uppercase; }
.mes-count { font-size: 1.2rem; font-weight: bold; color: #fff; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
<div class="container">
  <h1>Gest√£o Oficina v6.4</h1>

  <div class="tab-container">
    <button class="tab-button active" onclick="openTab('tab-entrada', this)">üìù Lan√ßamento</button>
    <button class="tab-button" onclick="openTab('tab-inventario', this)">üìã Banco de Dados</button>
  </div>

  <div id="tab-entrada" class="tab-content active">
    <div class="card">
      <h2 style="margin-top:0; color:#fff; font-size:1.2rem;">Novo Registro</h2>
      <div class="row">
        <div><label>OM</label><input id="om" placeholder="Ex: 198" type="tel"></div>
        <div><label>Patrim√¥nio</label><input id="patrimonio" placeholder="Ex: 102030" type="tel"></div>
      </div>
      <label>Equipamento</label>
      <select id="nome" onchange="autoPreencher()">
        <option value="">-- Selecione o item --</option>
      </select>
      <div class="row">
        <div><label>Horas</label><input id="horas" type="number" step="0.01" inputmode="decimal"></div>
        <div><label>Valor Unit. (R$)</label><input id="valor" type="number" step="0.01" inputmode="decimal"></div>
      </div>
      <button class="btn-main" onclick="addItem()">SALVAR REGISTRO</button>
    </div>
    
    <div class="card">
      <h3 style="margin-top:0; margin-bottom:15px; font-size:1rem; color:#a0aec0;">Resumo da Sess√£o</h3>
      <div class="row">
        <div class="stat-box">
          <div style="color:#98a3b3; font-size:0.8rem;">Horas Totais</div>
          <div id="totalHorasEntrada" class="stat-val" style="color:#fff">0.00</div>
        </div>
        <div class="stat-box">
          <div style="color:#98a3b3; font-size:0.8rem;">Custo Total</div>
          <div id="totalValorEntrada" class="stat-val">R$ 0,00</div>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-inventario" class="tab-content">
    <div class="card" style="border-bottom: 2px solid #2b9cff;">
      <h3 style="margin:0 0 10px 0; font-size: 0.9rem; color: #2b9cff;">üìä M√°quinas Cadastradas por M√™s</h3>
      <div id="gridMeses" class="meses-grid"></div>
    </div>

    <div class="card">
      <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; align-items: center;">
        <button onclick="shareFile('pdf')" class="btn-share">üìÑ PDF</button>
        <button onclick="shareFile('excel')" class="btn-share">üìä Excel</button>
        <button onclick="exportBackup()" class="btn-blue">üíæ Backup</button>
        <label class="btn-import">
          üìÇ Importar <input type="file" accept=".json" hidden onchange="importBackupMensal(event)">
        </label>
        <button onclick="deleteSelected()" class="btn-red" style="margin-left: auto;">üóëÔ∏è</button>
      </div>

      <input type="text" id="searchInput" placeholder="üîç Pesquisar por OM, Patr ou Nome..." onkeyup="load()" style="margin-bottom: 15px; border: 1px solid #2b9cff;">

      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th style="width: 30px; text-align:center;"><input type="checkbox" onclick="toggleAll(this)"></th>
              <th>Data</th>
              <th>OM</th>
              <th>Patr.</th>
              <th>Equipamento</th>
              <th>Horas</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="lista"></tbody>
        </table>
      </div>
      
      <div style="margin-top:10px; text-align:right; color:#98a3b3; font-size:0.8rem;">
        Total de itens: <span id="itemCount">0</span>
      </div>
    </div>
  </div>
</div>

<script>
/* --- CONFIGURA√á√ÉO E TABELA DE PRE√áOS --- */
const tabelaPrecos = [
  { nome: "ACABADORA DE SUPERFICIE", valor: 2.00, horas: 5.0 },
  { nome: "BALANCIM CADEIRINHA", valor: 2.00, horas: 2.25 },
  { nome: "BANCADA DE SERRA", valor: 8.00, horas: 4.5 },
  { nome: "BETONEIRA 150 LT", valor: 6.00, horas: 4.5 },
  { nome: "BETONEIRA 400 LT", valor: 6.00, horas: 4.5 },
  { nome: "BETONEIRA 600 LT", valor: 16.90, horas: 16.0 },
  { nome: "BOMBA MANGOTE", valor: 4.00, horas: 3.0 },
  { nome: "BOMBA SUBMERSA", valor: 4.00, horas: 4.0 },
  { nome: "COMPACTADOR", valor: 3.00, horas: 4.0 },
  { nome: "CORTADORA", valor: 3.00, horas: 4.0 },
  { nome: "GERADOR", valor: 3.00, horas: 3.2 },
  { nome: "GUINCHO DE ELEVA√á√ÉO", valor: 10.00, horas: 6.0 },
  { nome: "MARTELO 2 KG - 220V", valor: 1.50, horas: 2.0 },
  { nome: "MARTELO 5,7 KG - 220V", valor: 1.50, horas: 2.0 },
  { nome: "MARTELO 6 KG - 220V", valor: 1.70, horas: 2.0 },
  { nome: "MARTELO 11 KG - ROT", valor: 2.00, horas: 2.2 },
  { nome: "MARTELO 11 KG - 220V", valor: 1.70, horas: 2.2 },
  { nome: "MARTELO 16/19 KG", valor: 2.00, horas: 2.3 },
  { nome: "MARTELO 19 KG - 220V", valor: 2.00, horas: 2.5 },
  { nome: "MARTELO 30 KG - 220V", valor: 2.00, horas: 2.5 },
  { nome: "MINI GRUA", valor: 10.00, horas: 6.0 },
  { nome: "MOTOR - ACIONADOR", valor: 3.00, horas: 3.0 },
  { nome: "MOTOR - ELET TRIFA", valor: 3.00, horas: 3.0 },
  { nome: "PLACA VIBRATORIA", valor: 3.50, horas: 4.5 },
  { nome: "R√âGUA VIBRAT√ìRIA", valor: 5.00, horas: 4.5 },
  { nome: "TORRE DE ILUMINA√á√ÉO", valor: 25.00, horas: 6.0 },
  { nome: "UNIDADE HIDR√ÅULICA", valor: 8.00, horas: 16.0 },
  { nome: "VIBRADOR DE IMERS√ÉO", valor: 2.80, horas: 4.0 },
  { nome: "ROLO COMPACTADOR", valor: 20.00, horas: 24.0 },
  { nome: "MINI CARREGADEIRA", valor: 34.00, horas: 16.0 },
  { nome: "MINI ESCAVADEIRA", valor: 34.00, horas: 16.0 },
  { nome: "VELOX", valor: 8.00, horas: 6.0 },
  { nome: "PERFURATRIZ", valor: 25.00, horas: 6.0 }
];

const select = document.getElementById("nome");
tabelaPrecos.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(i=>select.innerHTML+=`<option value="${i.nome}">${i.nome}</option>`);

/* --- RESGATE DE DADOS E MIGRA√á√ÉO --- */
let inventoryData = [];
const currentKey = "oficina_inventory_v6.4"; 

function initData() {
    const saved = localStorage.getItem(currentKey);
    const todasAsChaves = [
        "oficina_inventory_v6.3",
        "oficina_inventory_v6.2", 
        "oficina_inventory_v6.1", 
        "oficina_inventory_v6", 
        "oficina_inventory", 
        "oficina_v4",
        "oficina_dados"
    ];

    let dadosEncontrados = [];

    todasAsChaves.forEach(key => {
        const item = localStorage.getItem(key);
        if (item) {
            try {
                const parsed = JSON.parse(item);
                if (Array.isArray(parsed)) {
                    parsed.forEach(novoItem => {
                        if (!dadosEncontrados.find(d => d.id === novoItem.id)) {
                            dadosEncontrados.push({
                                id: novoItem.id || Date.now() + Math.random(),
                                data: novoItem.data || new Date().toISOString(),
                                om: novoItem.om || novoItem.ordem || '',
                                patrimonio: novoItem.patrimonio || '',
                                nome: novoItem.nome || novoItem.equipamento || '',
                                horas: Number(novoItem.horas || 0),
                                valor: Number(novoItem.valor || novoItem.preco || 0)
                            });
                        }
                    });
                }
            } catch(e) {}
        }
    });

    if (dadosEncontrados.length > 0) {
        inventoryData = dadosEncontrados;
        saveData(); 
    } else if (saved) {
        inventoryData = JSON.parse(saved);
    }
}

function saveData() { localStorage.setItem(currentKey, JSON.stringify(inventoryData)); }

/* --- FUNCIONALIDADES --- */
function openTab(id, btn) {
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
}

function autoPreencher() {
  const item = tabelaPrecos.find(i=>i.nome===select.value);
  if(item){
    document.getElementById("horas").value = item.horas;
    document.getElementById("valor").value = item.valor.toFixed(2);
  }
}

function addItem() {
  const om = document.getElementById("om").value;
  const nome = select.value;
  if(!om || !nome) return alert("Preencha OM e Equipamento");

  inventoryData.push({
    id: Date.now(),
    data: new Date().toISOString(),
    om: om,
    patrimonio: document.getElementById("patrimonio").value,
    nome: nome,
    horas: Number(document.getElementById("horas").value),
    valor: Number(document.getElementById("valor").value)
  });
  saveData(); load();
  document.getElementById("patrimonio").value = "";
  alert("Salvo!");
}

function load() {
  const termo = document.getElementById("searchInput").value.toLowerCase();
  const tbody = document.getElementById("lista");
  const gridMeses = document.getElementById("gridMeses");
  
  tbody.innerHTML = "";
  gridMeses.innerHTML = "";
  
  let th=0, tv=0, count=0;
  let contagemMeses = {};

  const sortedData = [...inventoryData].sort((a,b) => new Date(b.data) - new Date(a.data));

  sortedData.forEach(i => {
    const dataObj = i.data ? new Date(i.data) : new Date();
    const mesAno = dataObj.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
    contagemMeses[mesAno] = (contagemMeses[mesAno] || 0) + 1;

    if(termo && !`${i.om} ${i.patrimonio} ${i.nome}`.toLowerCase().includes(termo)) return;

    th += i.horas; tv += (i.horas * i.valor);
    count++;

    tbody.innerHTML += `<tr>
      <td style="text-align:center;"><input type="checkbox" class="row-select" data-id="${i.id}"></td>
      <td style="color:#98a3b3; font-size: 11px;">${dataObj.toLocaleDateString('pt-BR')}</td>
      <td><b>${i.om}</b></td>
      <td>${i.patrimonio}</td>
      <td>${i.nome}</td>
      <td>${i.horas.toFixed(2)}</td>
      <td style="color:#4ade80">R$ ${(i.horas*i.valor).toFixed(2)}</td>
    </tr>`;
  });

  for (const [mes, qtd] of Object.entries(contagemMeses)) {
    gridMeses.innerHTML += `
      <div class="mes-card">
        <div class="mes-nome">${mes}</div>
        <div class="mes-count">${qtd} m√°q.</div>
      </div>
    `;
  }

  document.getElementById("totalHorasEntrada").innerText = th.toFixed(2);
  document.getElementById("totalValorEntrada").innerText = "R$ " + tv.toFixed(2);
  document.getElementById("itemCount").innerText = count;
}

function toggleAll(src) { document.querySelectorAll(".row-select").forEach(c=>c.checked=src.checked); }

function deleteSelected() {
  const checks = document.querySelectorAll(".row-select:checked");
  if(!checks.length || !confirm("Excluir?")) return;
  const ids = Array.from(checks).map(c=>Number(c.dataset.id));
  inventoryData = inventoryData.filter(i=>!ids.includes(i.id));
  saveData(); load();
}

function sendFile(blob, filename) {
  const reader = new FileReader();
  reader.onloadend = () => {
    const base64 = reader.result.split(',')[1];
    if (window.Android && window.Android.downloadFile) {
        window.Android.downloadFile(base64, filename);
    } else {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
    }
  };
  reader.readAsDataURL(blob);
}

function shareFile(type) {
  if (type === 'pdf') {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Relatorio Oficina", 14, 15);
    const rows = inventoryData.map(i=>[new Date(i.data).toLocaleDateString('pt-BR'), i.om, i.nome, i.horas, (i.horas*i.valor).toFixed(2)]);
    doc.autoTable({ head: [['Data', 'OM', 'Item', 'Horas', 'Total']], body: rows, startY: 20 });
    sendFile(doc.output('blob'), 'oficina.pdf');
  } else {
    const ws = XLSX.utils.json_to_sheet(inventoryData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Dados");
    const out = XLSX.write(wb, { type: 'array', bookType: 'xlsx' });
    sendFile(new Blob([out]), 'oficina.xlsx');
  }
}

function exportBackup() {
    const blob = new Blob([JSON.stringify(inventoryData)], {type: 'application/json'});
    sendFile(blob, `backup_oficina.json`);
}

function importBackupMensal(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const imported = JSON.parse(e.target.result);
      if (Array.isArray(imported)) {
        inventoryData = imported;
        saveData(); load();
        alert("‚úÖ Importado!");
      }
    } catch (err) { alert("‚ùå Erro no arquivo."); }
  };
  reader.readAsText(file);
}

initData();
load();
</script>
</body>
</html>